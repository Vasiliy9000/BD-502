Требуется создать собственный модуль, который пока что будет предназначен только для хранения каких-либо настроек, которые желательно менять через админку, а не через env.

На текущий момент требуется создать следующие настройки:

вкладка "Cron":
блок "Отчёт о завершённых сделках":
поле "Отправлять ежедневный отчёт" - чекбокс;
поле "Email-адрес для отправки отчёта" - строка (добавить пояснение, что может быть указано несколько адресов через запятую);
поле "Дата и время последней отправки отчёта" - дата и время, только для чтения;
поле "Количество сделок, отправленных в последнем отчёте" - число, только для чтения.
Далее необходимо внедрить использование этих настроек в отправке ежедневного отчёта о сделках (см. https://jira.cargonomica.com/browse/BD-427). 
 В самом начале запуска скрипта проверять, что поле "Отправлять ежедневный отчёт" установлено в значение "Y". 
 Если нет - писать в лог сообщение, что формирование отчёта отключено в настройках модуля. Отправка письма должна осуществляться на адрес (или адреса), указанный в настройках. 
 Если адрес не заполнен, писать в лог ошибку. Если отчёт был отправлен, то должны обязательно измениться значения двух оставшихся полей.



-----------------------------------------------------------------------------------------------


просмотрел, что было сделано по задаче BD-427

написал прототип модуля, написал генерацию страницы настроек в options.php, попытался переписать её используя только CAdminTabControl, разбирался почему поехала верстка

дописал генератор страницы настроек, создал тестовую вкладку с данными отладки, проверил сохранение и установку настроек для модуля

встроил проверку значения настроек в скрипт отправки отчетов, проверил работу на тестовых данных, подчистил отладочную вкладку, поправил code style

Почистил index.php от тестовых функций.

В options.php убрал скрытый input и переписал js-скрипт так, чтобы value устанавливалось напрямую чекбоксу на основе его атрибута checked (иначе почему-то не передается значение в post-запросе); добавил комментарий к скрипту. 
Выяснил, что проверку на наличие прав к странице лучше оставить, но поменял условие: вместо выполнения блока if при наличии прав теперь делается return при недостатке прав.  
Изменил метод получения данных из POST с $_POST на \Bitrix\Main\Context::getCurrent()>getRequest()>getPost().
Убрал присвоение в options.php присвоение значений параметрам last_report_timestamp и last_report_deal_count с полей формы - на странице настроек модуля должны только отображаться их значения.

Переместил проверку настройки по включению отправки ежедневного отчета из scvReportSender.php в DealReportService.php, поменял там все echo на $this->logger->info(). 
Там же убрал foreach на отправку нескольким отправителям, вместо этого прописал отправителей через запятую. 
Убрал так же foreach на вывод статусов отправки по каждому отправителю - теперь выводится только инфо трем статусам: всем отправлено, частично отправлено, никому не отправлено. 
Добавил проверку массива адресов электронной почты на пустой массив. 


Истратенков Глеб добавил(а) комментарий - 16/авг/24 12:48 AM
Ещё комментарии в гитлаб + добавил файл options.php как пример реализации.


Что было сделано. 
По примеру приложенного файла переписан options.php модуля cargonomica.main; добавлено использование функционала локализации (/lang/ru/options.php).
Получение списка получателей перенесено из csvReportSender.php в DealReportService.php, в последнем уточнены уровни серьезности логов, создаваемых после попытки отправки писем + исправления по остальным комментариям


Что было сделано.
Добавлен сервис CargonomicaMainOptionsService с константой id модуля, методами получения и установки значений настроек, методом setTitle(). Добавлено использование этих методов в options.php модуля и DealReportService.php


Что было сделано.
Прописан phpDoc для CargonomicaMainOptionsService


Истратенков Глеб добавил(а) комментарий - 21/авг/24 4:04 PM
Ревью ОК:



Истратенков Глеб добавил(а) комментарий - 21/авг/24 4:41 PM
Кроме того, нужно:

Установить модуль cargonomica.main.
Заполнить поля модуля.

После установки модуля при попытке зайти в его настройки фаталка:


Что было сделано.
Изменен тип возвращаемого значения getOption на string|null (upd. при следующем взаимодействии с этим кодом стоить поменять на ?string)



Кроме того, нужно:

Установить модуль cargonomica.main.
Заполнить поля модуля.
